# ä¼ä¸šçº§é‚®ç®±éªŒè¯æ–¹æ¡ˆè®¾è®¡ (v2.0 å‡çº§ç‰ˆ)

> æœ¬æ–¹æ¡ˆåŸºäºåŸæ–¹æ¡ˆè¿›è¡Œæ·±åº¦å®‰å…¨åŠ å›ºä¸æ¶æ„å‡çº§ï¼Œä¿®å¤äº† Redis Key å†²çªã€æ— çŠ¶æ€æ ¡éªŒã€æ˜æ–‡å­˜å‚¨ç­‰é«˜å±éšæ‚£ï¼Œå¹¶å¼•å…¥äº†é˜²é‡æ”¾ Tokenã€å¼‚æ­¥åŒ–å‘é€ç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚

## 1. æ ¸å¿ƒå®‰å…¨å‡çº§ç‚¹ (Diff)

| æ£€æŸ¥é¡¹ | åŸæ–¹æ¡ˆ (v1.0) | **æ–°æ–¹æ¡ˆ (v2.0)** | é£é™©ç­‰çº§ |
| :--- | :--- | :--- | :--- |
| **Redis Key** | `email_code:{email}` | `email:code:{type}:{email}` | ğŸ”¥ğŸ”¥ é«˜å± (ä¸šåŠ¡ä¸²ç ) |
| **éªŒè¯æ ¡éªŒ** | æ— çŠ¶æ€æ¯”å¯¹ (æ— é™é‡è¯•) | **æœ‰çŠ¶æ€è®¡æ•°** (è¶…è¿‡ 3 æ¬¡å¼ºåˆ¶å¤±æ•ˆ) | ğŸ”¥ğŸ”¥ é«˜å± (æš´åŠ›ç ´è§£) |
| **æ•°æ®å­˜å‚¨** | éªŒè¯ç æ˜æ–‡å…¥åº“ | **Hash è„±æ•å­˜å‚¨** / ä»…å­˜æ©ç  | ğŸ”¥ğŸ”¥ é«˜å± (æ•°æ®æ³„éœ²) |
| **é˜²é‡æ”¾** | éªŒè¯é€šè¿‡å³ç»“æŸ | éªŒè¯é€šè¿‡é¢å‘ **ä¸€æ¬¡æ€§ Token** | â­ ä¸­ (æµç¨‹ç»•è¿‡) |
| **å‘é€æ€§èƒ½** | åŒæ­¥é˜»å¡ | **@Async å¼‚æ­¥ / MQ è§£è€¦** | â­ ä¸­ (ååé‡ä½) |
| **é¢‘æ§æœºåˆ¶** | ä»…é‚®ç®±ç»´åº¦ | **å¤šç»´åº¦é¢‘æ§** (IP + é‚®ç®± + ä¸šåŠ¡ç±»å‹) | â­ ä¸­ (æ¶æ„åˆ·é‡) |

---

## 2. è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### 2.1 ä¸šåŠ¡æšä¸¾å®šä¹‰ (æ¶ˆé™¤é­”æ³•å€¼)

ä½¿ç”¨ Enum ä¸¥æ ¼ç®¡ç†ä¸šåŠ¡ç±»å‹ï¼Œé˜²æ­¢å­—ç¬¦ä¸²æ‹¼å†™é”™è¯¯å’Œéæ³•è°ƒç”¨ã€‚

```java
package com.dseven.rolepermission.biz.mail.enums;

public enum EmailBizType {
    REGISTER("register", "ç”¨æˆ·æ³¨å†Œ"),
    RESET_PASSWORD("reset_password", "é‡ç½®å¯†ç "),
    BIND_EMAIL("bind_email", "ç»‘å®šé‚®ç®±");

    private final String type;
    private final String desc;

    EmailBizType(String type, String desc) {
        this.type = type;
        this.desc = desc;
    }

    public String getType() { return type; }
}
```

### 2.2 Redis Key ä½“ç³»è®¾è®¡

é‡‡ç”¨åˆ†å±‚å‘½åç©ºé—´ï¼Œç¡®ä¿å„ä¸šåŠ¡éš”ç¦»ã€‚

| Key ç”¨é€” | Key æ ¼å¼ | TTL | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **éªŒè¯ç å­˜å‚¨** | `email:code:{type}:{email}` | 5-10 min | å­˜å‚¨çœŸå®éªŒè¯ç  |
| **é˜²æš´è¯•é”™** | `email:try:{type}:{email}` | 5-10 min | è®°å½•å·²å°è¯•æ¬¡æ•° (Max 3) |
| **å‘é€é¢‘æ§** | `email:rate:{type}:{email}` | 60 sec | é™åˆ¶å•ç”¨æˆ·å‘é€é—´éš” |
| **IP é¢‘æ§** | `email:rate:ip:{ip}` | 1 hour | é™åˆ¶å• IP å‘é€æ€»é‡ |
| **éªŒè¯å‡­è¯** | `email:token:{uuid}` | 15 min | éªŒè¯é€šè¿‡åé¢å‘çš„çŸ­æœŸä»¤ç‰Œ |

### 2.3 æ ¸å¿ƒæµç¨‹ä»£ç å®ç°

#### 2.3.1 å‘é€æ¥å£ (Async + å¤šç»´é¢‘æ§)

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SecureEmailService {

    private final RedisTemplate<String, Object> redisTemplate;
    private final MailSenderManager mailSenderManager; // å°è£…åº•å±‚å‘é€é€»è¾‘

    // å¸¸é‡é…ç½®
    private static final long CODE_EXPIRE_MIN = 10;
    private static final long SEND_INTERVAL_SEC = 60;
    private static final int MAX_IP_SEND_PER_HOUR = 10;

    /**
     * å‘é€éªŒè¯ç  (æ ¸å¿ƒå…¥å£)
     * æ— è®ºé‚®ç®±æ˜¯å¦å­˜åœ¨ï¼Œå‡è¿”å›æˆåŠŸï¼Œé˜²æ­¢æ’åº“
     */
    public void sendCode(String email, EmailBizType bizType, String clientIp) {
        // 1. IP é¢‘æ§æ£€æŸ¥ (Redis æ»‘åŠ¨çª—å£æˆ–è®¡æ•°å™¨)
        checkIpLimit(clientIp);

        // 2. é‚®ç®±é¢‘æ§æ£€æŸ¥
        String rateKey = String.format("email:rate:%s:%s", bizType.getType(), email);
        if (Boolean.TRUE.equals(redisTemplate.hasKey(rateKey))) {
            throw new BizException("å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"); // å®é™…ä¸Šç”Ÿäº§ç¯å¢ƒå¯¹å‰ç«¯å¯é™é»˜å¤„ç†
        }

        // 3. ç”ŸæˆéªŒè¯ç 
        String code = RandomUtil.randomNumbers(6);

        // 4. å¼‚æ­¥å‘é€é‚®ä»¶ (å…³é”®ä¼˜åŒ–)
        mailSenderManager.sendAsync(email, bizType, code);

        // 5. å­˜å…¥ Redis (äº‹åŠ¡æˆ– Pipeline ä¿è¯åŸå­æ€§)
        String codeKey = String.format("email:code:%s:%s", bizType.getType(), email);
        String tryKey = String.format("email:try:%s:%s", bizType.getType(), email);
        
        redisTemplate.execute((RedisCallback<Object>) connection -> {
            connection.openPipeline();
            // å­˜éªŒè¯ç 
            connection.stringCommands().setEx(codeKey.getBytes(), CODE_EXPIRE_MIN * 60, code.getBytes());
            // æ¸…ç©ºæ—§çš„è¯•é”™è®¡æ•°
            connection.keyCommands().del(tryKey.getBytes());
            // è®¾ç½®å‘é€é—´éš”
            connection.stringCommands().setEx(rateKey.getBytes(), SEND_INTERVAL_SEC, "1".getBytes());
            return connection.closePipeline();
        });
        
        // 6. è®°å½•æ—¥å¿— (è„±æ•/Hash)
        logEmailAction(email, bizType, code, clientIp);
    }
    
    private void checkIpLimit(String ip) {
        String ipKey = "email:rate:ip:" + ip;
        Long count = redisTemplate.opsForValue().increment(ipKey);
        if (count != null && count == 1) {
            redisTemplate.expire(ipKey, 1, TimeUnit.HOURS);
        }
        if (count != null && count > MAX_IP_SEND_PER_HOUR) {
            throw new BizException("å½“å‰IPè¯·æ±‚æ¬¡æ•°è¿‡å¤š");
        }
    }
}
```

#### 2.3.2 æ ¡éªŒæ¥å£ (æœ‰çŠ¶æ€ + é˜²é‡æ”¾ Token)

```java
    /**
     * æ ¡éªŒéªŒè¯ç å¹¶é¢å‘ Token
     * @return éªŒè¯æˆåŠŸåçš„ä¸´æ—¶ Token
     */
    public String verifyCode(String email, EmailBizType bizType, String inputCode) {
        String codeKey = String.format("email:code:%s:%s", bizType.getType(), email);
        String tryKey = String.format("email:try:%s:%s", bizType.getType(), email);

        // 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
        String realCode = (String) redisTemplate.opsForValue().get(codeKey);
        if (realCode == null) {
            throw new BizException("éªŒè¯ç å·²è¿‡æœŸæˆ–æœªå‘é€");
        }

        // 2. æ£€æŸ¥éªŒè¯ç æ˜¯å¦åŒ¹é…
        if (!realCode.equals(inputCode)) {
            // âŒ ç´¯åŠ é”™è¯¯æ¬¡æ•°
            Long retries = redisTemplate.opsForValue().increment(tryKey);
            if (retries != null && retries >= 3) {
                // è¶…è¿‡ 3 æ¬¡ï¼Œç›´æ¥åˆ é™¤éªŒè¯ç ï¼Œå¼ºåˆ¶é‡æ–°è·å–
                redisTemplate.delete(codeKey);
                redisTemplate.delete(tryKey);
                throw new BizException("éªŒè¯ç å·²å¤±æ•ˆ(é”™è¯¯æ¬¡æ•°è¿‡å¤š)");
            }
            throw new BizException("éªŒè¯ç é”™è¯¯ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°: " + (3 - retries));
        }

        // 3. âœ… éªŒè¯æˆåŠŸ
        // åˆ é™¤éªŒè¯ç é˜²æ­¢äºŒæ¬¡ä½¿ç”¨ (æˆ–è€…ä¿ç•™ä½†æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œè§†ä¸šåŠ¡éœ€æ±‚)
        redisTemplate.delete(codeKey);
        redisTemplate.delete(tryKey);

        // 4. ç”Ÿæˆä¸€æ¬¡æ€§ä¸šåŠ¡ Token (å…³é”®æ­¥éª¤)
        String verifyToken = UUID.randomUUID().toString();
        String tokenKey = "email:token:" + verifyToken;
        
        // Token ä¸­å­˜å‚¨ é‚®ç®±+ä¸šåŠ¡ç±»å‹ï¼Œæœ‰æ•ˆæœŸ 15 åˆ†é’Ÿ
        String tokenValue = email + ":" + bizType.getType();
        redisTemplate.opsForValue().set(tokenKey, tokenValue, 15, TimeUnit.MINUTES);

        return verifyToken;
    }
```

#### 2.3.3 ä¸šåŠ¡æ“ä½œæ¥å£ (æ¶ˆè´¹ Token)

```java
    /**
     * æœ€ç»ˆä¸šåŠ¡æ“ä½œ (å¦‚é‡ç½®å¯†ç )
     * å¿…é¡»æºå¸¦ verifyToken
     */
    public void resetPassword(String newPassword, String verifyToken) {
        String tokenKey = "email:token:" + verifyToken;
        String value = (String) redisTemplate.opsForValue().get(tokenKey);
        
        if (value == null) {
            throw new BizException("æ“ä½œä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯");
        }
        
        // è§£ææ•°æ®
        String[] parts = value.split(":");
        String email = parts[0];
        String type = parts[1];
        
        if (!EmailBizType.RESET_PASSWORD.getType().equals(type)) {
            throw new BizException("ä»¤ç‰Œç±»å‹ä¸åŒ¹é…");
        }
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘...
        userService.updatePassword(email, newPassword);
        
        // ğŸš€ é”€æ¯ Token (é˜²é‡æ”¾)
        redisTemplate.delete(tokenKey);
    }
```

### 2.4 å®‰å…¨æ—¥å¿—å­˜å‚¨æ–¹æ¡ˆ

**æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–**ï¼š

```sql
CREATE TABLE sys_email_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) NOT NULL,
    biz_type VARCHAR(50) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
    
    -- âŒ ä¸å­˜ code æ˜æ–‡
    -- âœ… å­˜ Hash å€¼ç”¨äºäº‹åå®¡è®¡ (å¯é€‰)
    code_hash VARCHAR(64) COMMENT 'éªŒè¯ç æŒ‡çº¹(HMAC-SHA256)',
    
    send_status TINYINT DEFAULT 0,
    client_ip VARCHAR(50),
    error_msg VARCHAR(500),
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_email_time (email, create_time),
    INDEX idx_ip_time (client_ip, create_time)
);
```

**æ—¥å¿—è®°å½•é€»è¾‘**ï¼š
```java
private void logEmailAction(String email, EmailBizType type, String code, String ip) {
    String salt = "sys_secret_salt"; // ä¹Ÿå¯ä»¥é…ç½®åŒ–
    String codeHash = SecureUtil.hmacSha256(code, salt); // ä½¿ç”¨ Hutool æˆ–å…¶ä»–å·¥å…·åº“
    
    EmailLog log = new EmailLog();
    log.setEmail(email);
    log.setBizType(type.getType());
    log.setCodeHash(codeHash); // ä»…å­˜ Hash
    log.setClientIp(ip);
    // ... insert async
}
```

### 2.5 å¼‚æ­¥å‘é€é…ç½® (Spring Task)

åœ¨ `MailSenderManager` ä¸­ä½¿ç”¨ `@Async`ã€‚

```java
@Component
public class MailSenderManager {

    @Autowired
    private JavaMailSender javaMailSender;

    // é…ç½®çº¿ç¨‹æ± ï¼Œé¿å…å ç”¨ä¸»çº¿ç¨‹æ± 
    @Async("mailExecutor") 
    public void sendAsync(String email, EmailBizType type, String code) {
        try {
            // å‘é€é€»è¾‘...
        } catch (Exception e) {
            log.error("é‚®ä»¶å‘é€å¤±è´¥: {} -> {}", email, e.getMessage());
            // å¯ä»¥åœ¨è¿™é‡Œåšç®€å•çš„é‡è¯•æˆ–è®°å½•å¤±è´¥æ—¥å¿—è¡¨ä¾›å®šæ—¶ä»»åŠ¡é‡å‘
        }
    }
}
```

**çº¿ç¨‹æ± é…ç½®**ï¼š
```yaml
spring:
  task:
    execution:
      pool:
        core-size: 5
        max-size: 20
        queue-capacity: 1000
        keep-alive: 60s
      thread-name-prefix: mail-task-
```

## 3. æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡å¼•å…¥ **å¤šç»´åº¦ Redis Key**ã€**æœ‰çŠ¶æ€æ ¡éªŒæœºåˆ¶**ã€**Token ä»¤ç‰Œæµ** å’Œ **å¼‚æ­¥æ¶æ„**ï¼Œå½»åº•è§£å†³äº†åŸæ–¹æ¡ˆå­˜åœ¨çš„ä¸šåŠ¡ä¸²ç ã€æš´åŠ›ç ´è§£ã€æ•°æ®æ³„éœ²å’Œæ€§èƒ½ç“¶é¢ˆé—®é¢˜ã€‚å»ºè®®åœ¨å®æ–½æ—¶ä¼˜å…ˆæ›¿æ¢ Redis Key ç»“æ„å’Œæ ¡éªŒé€»è¾‘ï¼Œè¿™æ˜¯å®‰å…¨åº•çº¿ã€‚
